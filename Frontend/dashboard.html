<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="css/styles.css" rel="stylesheet" />
</head>
<body class="d-flex justify-content-center align-items-center vh-100">
  <div class="container py-4">
    <div class="text-end mb-3">
      <button id="logoutBtn" class="btn btn-danger">Logout</button>
    </div>

    <h2 class="mb-4 text-center">User Dashboard</h2>

    <!-- User homes list -->
    <div id="user-section">
      <h4>Your Homes</h4>
      <ul class="list-group" id="homes-list"></ul>
    </div>

    <!-- Devices of selected home -->
    <div id="devices-section" class="mt-4" style="display: none;">
      <h5>Devices in selected home</h5>
      <ul class="list-group" id="devices-list">
        <!-- Loaded dynamically -->
      </ul>
    </div>
  </div>

  <script>
    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    function selectHome(homeId) {
      console.log("Selected home:", homeId);
      localStorage.setItem("selectedHome", homeId);
      loadDevices(homeId);
    }

    async function loadHomes() {
      const token = localStorage.getItem("jwt");
      const list = document.getElementById("homes-list");
      list.innerHTML = "";

      try {
        const res = await fetch("http://84.220.36.142:8080/api/homes", {
          headers: { Authorization: "Bearer " + token }
        });

        const homes = await res.json();

        homes.forEach(home => {
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `
            <span>${home.name}</span>
            <button class="btn btn-sm btn-primary" onclick="selectHome('${home.id}')">Select</button>
          `;
          list.appendChild(li);
        });
      } catch (err) {
        console.error("Error loading homes:", err);
        alert("Failed to load homes.");
      }
    }

    async function loadDevices(homeId) {
      const token = localStorage.getItem("jwt");
      const list = document.getElementById("devices-list");
      list.innerHTML = "";

      try {
        const res = await fetch(`http://84.220.36.142:8080/api/homes/${homeId}/devices`, {
          headers: { Authorization: "Bearer " + token }
        });

        const devices = await res.json();

        if (devices.length === 0) {
          list.innerHTML = "<li class='list-group-item'>No devices found.</li>";
        }

        devices.forEach(device => {
          const li = document.createElement("li");
          li.className = "list-group-item";

          let status = device.type === "SHUTTER"
            ? `Open: ${device.percentage}%`
            : `Value: ${device.value}`;

          let controls = "";

          if (device.type === "SHUTTER") {
            controls = `
              <div class="mt-2">
                <button class="btn btn-sm btn-success me-2" onclick="sendShutterCommand('${device.id}', 'open')">Open</button>
                <button class="btn btn-sm btn-danger me-2" onclick="sendShutterCommand('${device.id}', 'close')">Close</button>
                <button class="btn btn-sm btn-secondary" onclick="sendShutterCommand('${device.id}', 'partial')">Open 30%</button>
              </div>
            `;
          }

          li.innerHTML = `
            <strong>${device.name}</strong> (${device.type})<br>
            ${status}
            ${controls}
          `;

          list.appendChild(li);
        });

        document.getElementById("devices-section").style.display = "block";
      } catch (err) {
        console.error("Error loading devices:", err);
        alert("Failed to load devices.");
      }
    }

    async function sendShutterCommand(deviceId, command) {
      const token = localStorage.getItem("jwt");

      try {
        const res = await fetch(`http://84.220.36.142:8080/api/shutters/${deviceId}/command`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify({ command: command })
        });

        if (res.ok) {
          alert("Command sent!");
          const homeId = localStorage.getItem("selectedHome");
          loadDevices(homeId);
        } else {
          alert("Error sending command.");
        }
      } catch (err) {
        console.error(err);
        alert("Network error.");
      }
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("jwt");
      window.location.href = "login.html";
    });

    window.onload = () => {
      const token = localStorage.getItem("jwt");
      if (!token) {
        alert("Access denied. Please log in.");
        window.location.href = "login.html";
        return;
      }

      const payload = parseJwt(token);
      if (payload.role !== "ADMIN") {
        document.getElementById("user-section").style.display = "block";
        loadHomes();
      }
    };
  </script>
</body>
</html>
